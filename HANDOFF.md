# 引き継ぎドキュメント（HANDOFF.md）

最終更新日: 2026-01-01

## 📋 目次

1. [現在の状態 - 完了した作業と動作状況](#現在の状態---完了した作業と動作状況)
2. [アーキテクチャ概要](#アーキテクチャ概要)
3. [技術的な詳細](#技術的な詳細)
4. [次のセッションで検討すべき改善項目](#次のセッションで検討すべき改善項目)
5. [動作確認チェックリスト](#動作確認チェックリスト)
6. [既知の課題](#既知の課題)
7. [次の優先タスク](#次の優先タスク)
8. [トラブルシューティング](#トラブルシューティング)

---

## 現在の状態 - 完了した作業と動作状況

### ✅ 完了した作業（本セッション）

1. **AuthContext の実装** (`lib/contexts/AuthContext.tsx`)
   - Firebase Authentication の状態監視
   - 職員情報と組織情報の自動読み込み
   - ログイン/ログアウト機能
   - グローバルな認証状態管理

2. **AuthGuard の実装** (`components/AuthGuard.tsx`)
   - 認証が必要なページの保護
   - 未認証時のログインページへの自動リダイレクト
   - パスワード未設定時の自動リダイレクト
   - ローディング状態の表示

3. **RootLayout への AuthProvider 統合**
   - アプリ全体で認証状態にアクセス可能に
   - グローバルなAuthContextプロバイダー

4. **組織ID のハードコード解消**
   - スタッフ一覧 (`app/staff/page.tsx`)
   - 利用者一覧 (`app/clients/page.tsx`)
   - AuthContext から組織情報を動的に取得

5. **Navigation コンポーネントの強化**
   - ログアウト機能の追加
   - ログイン中のユーザー情報表示
   - 組織名の表示

6. **ログインページの統合**
   - AuthContext との統合
   - すでにログイン済みの場合の自動リダイレクト
   - ログイン後の元ページへの復帰機能（returnUrl パラメータ）

### ✅ 既存の完了済み機能（前セッション）

#### 認証・ログイン機能
- **初回ログイン（完全認証）**: 事業所番号 + 個人番号 + パスワード
- **簡易ログイン（信頼済みデバイス）**:
  - PIN認証（4〜6桁）
  - 生体認証（顔認証・指紋認証）- Web Authentication API使用
- デバイスを信頼済みとして登録
- ログイン方式の自動切り替え

#### スタッフ管理
- スタッフ一覧（検索・絞り込み機能付き）
- スタッフ新規登録
- スタッフ詳細表示
- スタッフ編集
- CSV一括インポート
- 退職処理

#### 利用者管理
- 利用者一覧（検索・絞り込み機能付き）
- 利用者新規登録
- 利用者詳細表示
- 利用者編集
- CSV一括インポート

#### 事業所管理
- 事業所新規登録
- 事業所詳細表示
- 初回セットアップフロー

#### ダッシュボード
- スタッフ、利用者、事業所の統計情報表示
- クイックアクション
- 主要機能へのリンク

---

## アーキテクチャ概要

### 認証フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                        AuthProvider                              │
│  (app/layout.tsx で全体をラップ)                                  │
│                                                                   │
│  1. Firebase Auth の状態監視 (onAuthStateChanged)                │
│  2. ユーザー情報の自動読み込み                                    │
│     - Firestore から職員情報を取得                               │
│     - Firestore から組織情報を取得                               │
│  3. グローバルな認証状態を提供                                    │
│     - user (Firebase User)                                       │
│     - staff (Staff データ)                                       │
│     - organization (Organization データ)                         │
│     - isAuthenticated (認証済みフラグ)                           │
│     - signOut (ログアウト関数)                                   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                         AuthGuard                                 │
│  (認証が必要なページで使用)                                        │
│                                                                   │
│  1. 認証状態をチェック                                            │
│  2. 未認証の場合 → /auth/login にリダイレクト                    │
│  3. パスワード未設定の場合 → /auth/setup-password にリダイレクト │
│  4. 認証済みの場合 → コンテンツを表示                            │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                    各ページコンポーネント                          │
│  (staff/page.tsx, clients/page.tsx など)                         │
│                                                                   │
│  1. useAuth() フックで認証情報を取得                             │
│  2. organization.id を使ってデータを取得                         │
│  3. user.uid を使って更新操作を実行                              │
└─────────────────────────────────────────────────────────────────┘
```

### ファイル構成

```
bloom-connect/
├── app/
│   ├── layout.tsx                     # AuthProvider でラップ
│   ├── page.tsx                       # ダッシュボード（認証不要）
│   ├── auth/
│   │   ├── login/page.tsx            # ログインページ（認証不要）
│   │   └── setup-password/page.tsx   # パスワード設定（認証必須）
│   ├── staff/
│   │   ├── page.tsx                  # スタッフ一覧（AuthGuard）
│   │   ├── new/page.tsx              # スタッフ新規登録
│   │   ├── [id]/page.tsx             # スタッフ詳細
│   │   └── [id]/edit/page.tsx        # スタッフ編集
│   ├── clients/
│   │   ├── page.tsx                  # 利用者一覧（AuthGuard）
│   │   ├── new/page.tsx              # 利用者新規登録
│   │   ├── [id]/page.tsx             # 利用者詳細
│   │   └── [id]/edit/page.tsx        # 利用者編集
│   └── organizations/
│       ├── page.tsx                  # 事業所一覧
│       ├── new/page.tsx              # 事業所新規登録
│       └── [id]/page.tsx             # 事業所詳細
├── lib/
│   ├── contexts/
│   │   └── AuthContext.tsx           # 🆕 認証コンテキスト
│   ├── firebase.ts                   # Firebase 初期化
│   ├── auth/
│   │   ├── staff.ts                  # スタッフ認証関連
│   │   └── device.ts                 # デバイス認証関連
│   └── firestore/
│       ├── auth.ts                   # 認証用 Firestore 関数
│       ├── staff.ts                  # スタッフデータ操作
│       ├── clients.ts                # 利用者データ操作
│       └── organizations.ts          # 事業所データ操作
├── components/
│   ├── AuthGuard.tsx                 # 🆕 認証ガード
│   ├── Navigation.tsx                # ナビゲーション（ログアウト機能追加）
│   └── LoadingSpinner.tsx            # ローディングスピナー
└── types/
    ├── auth.ts                       # 認証関連の型定義
    ├── staff.ts                      # スタッフの型定義
    ├── client.ts                     # 利用者の型定義
    └── organization.ts               # 事業所の型定義
```

---

## 技術的な詳細

### AuthContext の使い方

#### 1. 認証状態の取得

```tsx
import { useAuth } from '@/lib/contexts/AuthContext';

function MyComponent() {
  const { user, staff, organization, isAuthenticated, loading } = useAuth();

  if (loading) {
    return <div>読み込み中...</div>;
  }

  if (!isAuthenticated) {
    return <div>ログインしてください</div>;
  }

  return (
    <div>
      <p>ようこそ、{staff?.nameKanji}さん</p>
      <p>組織: {organization?.name}</p>
    </div>
  );
}
```

#### 2. ログアウト処理

```tsx
import { useAuth } from '@/lib/contexts/AuthContext';
import { useRouter } from 'next/navigation';

function LogoutButton() {
  const { signOut } = useAuth();
  const router = useRouter();

  const handleLogout = async () => {
    try {
      await signOut();
      router.push('/auth/login');
    } catch (error) {
      console.error('ログアウトエラー:', error);
    }
  };

  return <button onClick={handleLogout}>ログアウト</button>;
}
```

#### 3. 認証情報の再読み込み

```tsx
import { useAuth } from '@/lib/contexts/AuthContext';

function RefreshButton() {
  const { refreshAuth } = useAuth();

  return (
    <button onClick={refreshAuth}>
      認証情報を再読み込み
    </button>
  );
}
```

### AuthGuard の使い方

#### 認証が必要なページの保護

```tsx
import AuthGuard from '@/components/AuthGuard';

export default function ProtectedPage() {
  return (
    <AuthGuard requireAuth={true}>
      <div>
        {/* 認証済みユーザーのみアクセス可能なコンテンツ */}
      </div>
    </AuthGuard>
  );
}
```

#### 認証不要なページ（ログインページなど）

```tsx
// AuthGuard を使用しないか、requireAuth={false} を指定
export default function LoginPage() {
  return (
    <div>
      {/* 誰でもアクセス可能 */}
    </div>
  );
}
```

### データ取得パターン（組織IDの動的取得）

```tsx
import { useAuth } from '@/lib/contexts/AuthContext';
import { getStaffByOrganization } from '@/lib/firestore/staff';

function StaffList() {
  const { organization } = useAuth();
  const [staffList, setStaffList] = useState([]);

  useEffect(() => {
    if (organization?.id) {
      loadStaffList();
    }
  }, [organization?.id]);

  const loadStaffList = async () => {
    const data = await getStaffByOrganization(organization.id);
    setStaffList(data);
  };

  // ...
}
```

---

## 次のセッションで検討すべき改善項目

### 🔴 高優先度

#### 1. UI/UX の洗練
- [ ] フォームのバリデーション強化（リアルタイムエラー表示）
- [ ] エラーメッセージの統一（トースト通知の導入）
- [ ] モバイルレスポンシブの改善
- [ ] ローディング状態の統一
- [ ] 空状態（Empty State）のデザイン改善

#### 2. ダッシュボードの実装
- [ ] 統計情報の可視化（グラフ・チャート）
- [ ] 最近の活動履歴表示
- [ ] クイック検索機能
- [ ] お知らせ・通知機能

#### 3. 検索・フィルタ機能の強化
- [ ] 高度な検索機能（複数条件の組み合わせ）
- [ ] 検索結果のソート機能
- [ ] 保存された検索条件
- [ ] 検索履歴

### 🟡 中優先度

#### 4. 通知機能
- [ ] リアルタイム通知（Firestore リスナー）
- [ ] メール通知
- [ ] プッシュ通知（PWA）
- [ ] 通知設定画面

#### 5. データエクスポート
- [ ] PDF エクスポート
- [ ] Excel エクスポート
- [ ] CSVエクスポート（インポート機能は実装済み）
- [ ] 印刷用レイアウト

#### 6. 権限管理の詳細化
- [ ] ロールベースのアクセス制御（RBAC）の強化
- [ ] 組織内の権限階層
- [ ] 操作ログの記録
- [ ] 監査機能

### 🟢 低優先度

#### 7. パフォーマンス最適化
- [ ] ページネーション（現在は全件取得）
- [ ] 仮想スクロール（大量データの表示）
- [ ] 画像の最適化
- [ ] コード分割の最適化

#### 8. セキュリティ強化
- [ ] CSP（Content Security Policy）の設定
- [ ] レート制限
- [ ] 2要素認証（2FA）
- [ ] セッションタイムアウト

#### 9. その他
- [ ] オフライン対応（PWA）
- [ ] 多言語対応（i18n）
- [ ] ダークモード
- [ ] アクセシビリティ改善（ARIA属性、キーボードナビゲーション）

---

## 動作確認チェックリスト

### 認証フロー

- [ ] **初回ログイン**: 事業所番号 + 個人番号 + パスワードでログインできる
- [ ] **PIN認証**: 信頼済みデバイスで PIN 入力によるログインができる
- [ ] **生体認証**: 信頼済みデバイスで生体認証によるログインができる
- [ ] **ログアウト**: ログアウトボタンでログアウトできる
- [ ] **未認証時のリダイレクト**: 認証が必要なページにアクセスすると `/auth/login` にリダイレクトされる
- [ ] **ログイン後のリダイレクト**: ログイン後、元のページに戻る
- [ ] **すでにログイン済み**: ログイン済みの状態で `/auth/login` にアクセスすると `/` にリダイレクトされる

### スタッフ管理

- [ ] **スタッフ一覧**: 組織のスタッフ一覧が表示される
- [ ] **スタッフ検索**: 名前、職種、役職、メールアドレスで検索できる
- [ ] **スタッフ絞り込み**: 在職状態、権限ロールで絞り込みできる
- [ ] **スタッフ新規登録**: 新しいスタッフを登録できる
- [ ] **スタッフ詳細**: スタッフの詳細情報が表示される
- [ ] **スタッフ編集**: スタッフ情報を編集できる
- [ ] **スタッフ退職処理**: スタッフを退職状態にできる
- [ ] **CSV インポート**: CSV ファイルからスタッフを一括登録できる

### 利用者管理

- [ ] **利用者一覧**: 組織の利用者一覧が表示される
- [ ] **利用者検索**: 名前で検索できる
- [ ] **利用者絞り込み**: 利用状態、介護度で絞り込みできる
- [ ] **利用者新規登録**: 新しい利用者を登録できる
- [ ] **利用者詳細**: 利用者の詳細情報が表示される
- [ ] **利用者編集**: 利用者情報を編集できる
- [ ] **CSV インポート**: CSV ファイルから利用者を一括登録できる

### 事業所管理

- [ ] **事業所一覧**: 事業所一覧が表示される
- [ ] **事業所新規登録**: 新しい事業所を登録できる
- [ ] **事業所詳細**: 事業所の詳細情報が表示される

### ダッシュボード

- [ ] **統計情報**: スタッフ、利用者、事業所の総数と有効数が表示される
- [ ] **クイックアクション**: スタッフ追加、利用者追加、事業所追加のボタンが機能する
- [ ] **主要機能へのリンク**: 各管理画面へのリンクが機能する

### Navigation

- [ ] **ユーザー情報表示**: ログイン中のユーザー名と組織名が表示される
- [ ] **ログアウトボタン**: ログアウトボタンが表示され、クリックでログアウトできる
- [ ] **アクティブページのハイライト**: 現在のページがハイライトされる
- [ ] **モバイルメニュー**: モバイルでメニューが開閉できる

---

## 既知の課題

### 1. 静的エクスポートの制約
- Next.js の静的エクスポート（`output: 'export'`）を使用しているため、一部の動的機能に制限がある
- API Routes が使用できない
- サーバーサイドレンダリング（SSR）が使用できない

### 2. Firestore Security Rules
- 現在のセキュリティルールは基本的なもののみ
- より詳細な権限制御が必要
- 監査ログの記録が不十分

### 3. エラーハンドリング
- エラーメッセージの表示が統一されていない（alert、console.error、エラー表示コンポーネントが混在）
- ネットワークエラーの処理が不十分
- リトライ機能がない

### 4. パフォーマンス
- スタッフ一覧、利用者一覧でページネーションが未実装（全件取得）
- 大量データの表示に最適化が必要
- 画像の最適化が不十分

### 5. PIN認証・生体認証
- PIN認証、生体認証からの自動ログインが未完成（TODO コメント有り）
- Firebase Auth のカスタムトークンを使用した実装が必要

---

## 次の優先タスク

### 🥇 最優先（今すぐ取り組むべき）

1. **エラーメッセージの統一**
   - トースト通知ライブラリの導入（react-hot-toast など）
   - 全ページのエラー表示を統一

2. **フォームバリデーションの強化**
   - リアルタイムバリデーション
   - エラーメッセージの改善
   - 入力補助機能

3. **モバイルレスポンシブの改善**
   - テーブルのスクロール対応
   - フォームのレイアウト調整
   - タッチ操作の最適化

### 🥈 次に取り組むべき

4. **ダッシュボードの実装**
   - グラフ・チャートライブラリの導入（recharts など）
   - 統計情報の可視化
   - 最近の活動履歴

5. **検索・フィルタ機能の強化**
   - 高度な検索フォーム
   - 検索結果のソート
   - 保存された検索条件

6. **ページネーション機能**
   - スタッフ一覧、利用者一覧にページネーション追加
   - 無限スクロールの検討

### 🥉 時間があれば取り組むべき

7. **データエクスポート機能**
   - PDF エクスポート
   - Excel エクスポート

8. **通知機能**
   - リアルタイム通知
   - メール通知

9. **権限管理の詳細化**
   - ロールベースのアクセス制御の強化
   - 操作ログの記録

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. 「組織情報が取得できません」エラー
**原因**: AuthContext が組織情報を読み込む前にデータ取得を試みている

**解決方法**:
```tsx
useEffect(() => {
  if (organization?.id) {
    loadData();
  }
}, [organization?.id]);
```

#### 2. ログイン後にリダイレクトされない
**原因**: AuthGuard や AuthContext の状態が正しく更新されていない

**解決方法**:
- ブラウザのコンソールでエラーを確認
- Firebase Auth の状態を確認（`auth.currentUser`）
- Firestore のデータが正しく保存されているか確認

#### 3. ログアウト後もユーザー情報が表示される
**原因**: AuthContext の状態がクリアされていない

**解決方法**:
- ブラウザのキャッシュをクリア
- `signOut()` 関数が正しく実行されているか確認

#### 4. 「読み込み中...」が永遠に表示される
**原因**: AuthContext の `loading` 状態が `false` にならない

**解決方法**:
- Firebase の初期化が正しく行われているか確認（`.env.local` ファイル）
- ブラウザのネットワークタブでFirebaseへのリクエストを確認
- コンソールでエラーメッセージを確認

#### 5. 型エラー「Property does not exist on type 'never'」
**原因**: TypeScript の型推論が正しく行われていない

**解決方法**:
- 型定義を明示的に指定
```tsx
const [data, setData] = useState<MyType[]>([]);
```

---

## まとめ

### 完了した主要な機能

✅ **認証・セッション管理**: AuthContext、AuthGuard による完全な認証フロー
✅ **エンドユーザー向けアプリ基盤**: スタッフ管理、利用者管理、事業所管理
✅ **CSV一括登録**: スタッフ、利用者のCSVインポート
✅ **ダッシュボード**: 統計情報とクイックアクション
✅ **ログアウト機能**: Navigation コンポーネントにログアウトボタン追加

### 次のセッションでの推奨事項

1. エラーメッセージの統一（トースト通知）
2. フォームバリデーションの強化
3. モバイルレスポンシブの改善
4. ダッシュボードの実装
5. ページネーション機能

---

## 連絡先・参考資料

### ドキュメント
- [README.md](./README.md) - プロジェクト概要、セットアップ手順
- [Firebase Console](https://console.firebase.google.com/) - Firebase プロジェクト管理
- [Next.js Documentation](https://nextjs.org/docs) - Next.js 公式ドキュメント

### コードの主要な場所
- **認証**: `lib/contexts/AuthContext.tsx`, `components/AuthGuard.tsx`
- **Firestore操作**: `lib/firestore/*.ts`
- **型定義**: `types/*.ts`
- **ページコンポーネント**: `app/**/page.tsx`

---

このドキュメントは、次のセッションで作業を開始する際の参考資料として使用してください。質問や不明点があれば、このドキュメントを基に確認してください。
